{% extends 'layout.html' %}

{% block title %}Modulo Salud{% endblock %}

{% block body %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://bootswatch.com/5/materia/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/indexSalud.css') }}">
<div class="container-salud">
    <div class="container-indexSalud">
        <div class="row">

            <!-- Tabla de visualizaci√≥n de productos -->
            <div class="col-md-12">
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="tabla" class="table table-striped table-bordered bg-white table-sm"> 
                            <thead>
                                <tr>
                                    <th>Placa Equipo</th>
                                    <th>Nombre de Equipo</th>
                                    <th>Fecha Compra</th>
                                    <th>Fecha de Baja</th>
                                    <th>Tipo Equipo</th>
                                    <th>Software</th>
                                    <th>Estado Equipo</th>
                                    <!-- <th>Ubicaci√≥n original</th> -->
                                    <!-- <th>Responsable del Equipo</th> -->
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in equipos_de_baja_tecnologia %}
                                <tr>
                                    <!-- <td>
                                        <input 
                                            type="checkbox" 
                                            class="equipo-checkbox"
                                            data-codigo="{{ producto.cod_articulo }}" 
                                            data-nombre="{{ producto.nombre_equipo }}">

                                        <span>{{ producto.cod_articulo }}</span>
                                    </td> -->
                                    <td>{{ producto.cod_articulo }}</td>
                                    <td>{{ producto.nombre_equipo }}</td>
                                    <td>{{ producto.fecha_ingreso }}</td>
                                    <td>{{ producto.fecha_de_baja }}</td>
                                    <td>{{ producto.tipo_equipo }}</td>
                                    
                                    <td class="software-cell"
                                        title="{{ producto.software_instalado }}"
                                        data-full="{{ producto.software_instalado|e }}"
                                        data-short="{{ producto.software_instalado[:50]|e }}{% if producto.software_instalado|length > 50 %}...{% endif %}"> <!-- Esta linea muestra el texto en la columna-->

                                        <!-- TEXTO COMPLETO PARA FILTRO -->
                                        <span class="software-full">
                                            {{ producto.software_instalado }}
                                        </span>

                                        <!-- TEXTO CORTO VISIBLE -->
                                        <span class="software-short">
                                            {{ producto.software_instalado[:50] }}
                                            {% if producto.software_instalado|length > 50 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ producto.estado_equipo }}</td>

                                    <td>
                                        <div class="text-center mt-2">
                                            <a href="{{ url_for('main.GET_EQUIPO_TECNOLOGIA', id=producto['id'], vista='equiposDeBajaTecnologia') }}" class="btn btn-secondary btn-sm"><FONT SIZE=2>Editar/Ver hoja de vida</FONT></a>
                                        </div>

                                        <br>
                                        <!-- Bot√≥n para ver PDF DE BAJA -->
                                        {% if producto.pdf_debaja %}
                                            <a href="{{ url_for('main.ver_pdf_baja', filename=producto.pdf_debaja.replace('pdf/', '')) }}"
                                            target="_blank"
                                            class="btn btn-tabla btn-sm">
                                                Ver pdf de baja
                                            </a>
                                        {% else %}
                                            <span class="text-muted">SIN GUIA</span>
                                        {% endif %}

                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>                         
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<!-- boton de busqueda y filtro, con lenguaje en espa√±ol -->
<!-- <script>
    $("#tabla").DataTable({
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
        }
    }

    );

</script> -->

<script>
// <!-- boton de busqueda y filtro, con lenguaje en espa√±ol -->
document.addEventListener("DOMContentLoaded", function () {
    // Inicializar DataTable
    const tabla = $("#tabla").DataTable({
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
        }
    });

    // Repintar cada vez que la tabla se redibuja (cambio de p√°gina)
    tabla.on('draw.dt', function () {
        const searchTerm = tabla.search().trim().toLowerCase();

        document.querySelectorAll('.software-cell').forEach(td => {

            const full = td.dataset.full || "";
            const shortText = td.dataset.short || "";

            if (!searchTerm) {
                // üîÅ sin b√∫squeda ‚Üí vuelve resumido
                td.textContent = shortText;
                return;
            }

            const lowerFull = full.toLowerCase();
            const index = lowerFull.indexOf(searchTerm);

            if (index === -1) {
                // no match visible ‚Üí deja corto
                td.textContent = shortText;
                return;
            }

            // üß† sacar fragmento alrededor
            const CONTEXT = 25;

            const start = Math.max(0, index - CONTEXT);
            const end = Math.min(full.length, index + searchTerm.length + CONTEXT);

            let fragment = full.substring(start, end);

            if (start > 0) fragment = "..." + fragment;
            if (end < full.length) fragment += "...";

            // üé® highlight
            const regex = new RegExp(`(${searchTerm})`, "gi");
            fragment = fragment.replace(regex, '<mark>$1</mark>');

            td.innerHTML = fragment;
        });
    });
});
</script>

<script>
  const csrf_token = "{{ csrf_token() }}";
</script>

{% endblock %}