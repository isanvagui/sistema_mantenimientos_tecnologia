{% extends 'layout.html' %}

{% block title %}Modulo Tecnologia{% endblock %}

{% block body %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://bootswatch.com/5/materia/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/indexSalud.css') }}">
<div class="container-salud">
    <div class="container-indexSalud">
        <div class="row">
            <div class="col-md-12 mb-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category,message in messages %}
                            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-bs-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <br>
                <div class="div1-indexSalud" id="formContainer" style="display: none;">
                    <div class="card-indexSalud">
                        <form action="{{ url_for('main.add_equipos_tecnologia') }}" method="POST" enctype="multipart/form-data">
                            <div class="form-grid">
                                <!-- Aqu√≠ se ajusta el formulario para ser responsivo -->
                                <div class="row">
                                    <div class="col-md-6 form-group">
                                        <input type="text" name="cod_articulo" placeholder="Placa Equipo"
                                            class="form-control">
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <input type="text" name="nombre_equipo" placeholder="Nombre Equipo"
                                            class="form-control">
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <label for="tipo_equipo">Tipo Equipo</label>
                                        <select id="tipo_equipo" name="tipo_equipo" class="form-control" required>
                                            <!-- Opci√≥n inicial -->
                                            <option value="" disabled selected>Seleccione tipo</option>
                                            <!-- Opciones que se encuentran en la DB -->
                                            {% for tipoEquipo in tipoEquipos %}
                                            <option value="{{ tipoEquipo.tipo_equipo }}">{{ tipoEquipo.tipo_equipo }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <label for="estado_equipo">Estado Equipo</label>
                                        <select id="estado_equipo" name="estado_equipo" class="form-control" required>

                                            <option value="" disabled selected>Seleccione Estado</option>

                                            {% for estadoEquipo in estadoEquipos %}
                                            <option value="{{ estadoEquipo.estado_equipo }}">{{ estadoEquipo.estado_equipo }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <label for="id_proceso">Proceso</label>
                                        <select id="id_proceso" name="id_proceso" class="form-control" required>

                                            <option value="" disabled selected>Seleccione Proceso</option>

                                            {% for procesoEquipo in procesoEquipos %}
                                            <option value="{{ procesoEquipo.id }}">{{ procesoEquipo.proceso }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 form-group">
                                        <label for="id_persona_responsable">Responsable del Equipo</label>
                                        <select id="id_persona_responsable" name="id_persona_responsable" class="form-control" required>

                                            <option value="" disabled selected>Seleccione Responsable</option>

                                            {% for persona in personas %}
                                            <option value="{{ persona.id }}">{{ persona.nombre_contratista }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <input type="text" name="ubicacion" placeholder="Ubicaci√≥n" class="form-control">
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <input type="text" name="ram" placeholder="Memoria Ram" class="form-control">
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <input type="text" name="disco" placeholder="Disco Duro" class="form-control">
                                    </div>                                    

                                    <div class="col-md-6 form-group">
                                        <input type="text" name="marca_equipo_tecnologia" placeholder="Marca Equipo" class="form-control">
                                    </div>
                                    
                                    <div class="col-md-6 form-group">
                                        <input type="text" name="modelo_equipo_tecnologia" placeholder="Modelo Equipo" class="form-control">
                                    </div>
                                    
                                    <div class="col-md-6 form-group">
                                        <input type="text" name="serial_equipo_tecnologia" placeholder="Serial Equipo" class="form-control">
                                    </div>

                                    <div class="col-md-6 form-group mt-4">
                                         <input type="text" name="software_instalado" placeholder="Software Instalado" class="form-control">
                                    </div>

                                    <div class="col-md-6 form-group">
                                        <label for="fecha_ingreso" style="color: darkgray">Fecha Compra</label>
                                        <input id="fecha_ingreso" type="date" name="fecha_ingreso" class="form-control">
                                    </div>
                                    
                                    <div class="col-md-6 form-group">
                                        <!-- Subir Imagen -->
                                        <label for="imagen_producto" class="btn btn-secondary">Subir Imagen</label>
                                        <input type="file" id="imagen_producto" name="imagen_producto" class="d-none" >
                                        <span id="nombre-imagen" class="text-muted"></span>

                                        <!-- Subir PDF DE BAJA -->
                                        <label id="btnPdfBaja" for="pdf_debaja" class="btn btn-secondary disabled" aria-disabled="true">Subir PDF</label>
                                        <input type="file" id="pdf_debaja" name="pdf_debaja" class="d-none" accept="application/pdf" disabled>
                                        <span id="nombre-pdf" class="text-muted"></span>
                                    </div>

                                </div>
                            </div>
                            <input type="hidden" name="csrf_token" value="{{csrf_token()}}" />
                            <div class="form-group">
                                <center><button type="submit" class="btn-indexSalud">GUARDAR</button></center>
                            </div>
                        </form>
                    </div>

                </div>
            </div>

            <!-- New form for inserting EXCEL -->
            <div class="card-equipos-masivos" id="formContain" style="display: none;">
                <form  action="{{ url_for('main.insert_excel_tecnologia') }}" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <input type="file" name="file" accept=".xlsx" class="custom-file-input" required>
                    </div>
                    <!------ linea de token es necesaria ya que el sistema lo solicita-->
                    <input type="hidden" name="csrf_token" value="{{csrf_token() }}" />
                    <!---------------------- es solo esta linea----------------------->
                    <div class="form-group">
                        <center>
                            <button type="submit" class="btn-indexSalud">Ingresar equipos</button>
                        </center>
                    </div>
                </form>
            </div>
            <!-- Modal Para Actualizaci√≥n de Fechas y Guardado de Historial-->
            <div class="modal fade" id="modalGuardar" tabindex="-1" aria-labelledby="modalGuardarLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content modal-borde">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalGuardarLabel">Programar Mantenimiento y Guarda en el Historial</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>

                    <div class="modal-body">
                        <form id="form-checkbox-programacion" method="POST">
                        <div class="row g-3">
                            <!-- Selector de persona -->
                            <div class="col-md-4">
                            <label for="selectProveedor" class="form-label">Tecnico responsable</label>
                            <select name="proveedor_id" id="selectProveedor" class="form-control" required>
                                <option value="" disabled selected>Seleccione un tecnico</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre_tecnico }}</option>
                                {% endfor %}
                            </select>
                            </div>
                            
                            <!-- Selector de persona responable -->
                            <div class="col-md-4">
                            <label for="selectPersona" class="form-label">Persona responsable del equipo</label>
                            <select name="persona_id" id="selectPersona" class="form-control" required>
                                <option value="" disabled selected>Seleccione persona</option>
                                {% for persona in personas %}
                                <option value="{{ persona.id }}">{{ persona.nombre_contratista }}</option>
                                {% endfor %}
                            </select>
                            </div>

                            <!-- Selector de proceso -->
                            <div class="col-md-3">
                            <label for="selectProceso" class="form-label">Proceso</label>
                            <select name="proceso_id" id="selectProceso" class="form-control" required>
                                <!-- Opci√≥n inicial -->
                                <option value="" disabled selected>Seleccione Proceso</option>
                                <!-- Opciones que se encuentran en la DB -->
                                {% for procesoEquipo in procesoEquipos %}
                                <option value="{{ procesoEquipo.id }}">{{ procesoEquipo.proceso }}</option>
                                {% endfor %}
                            </select>
                            </div>
                            
                            <!-- Campo oculto para los equipos seleccionados -->
                            <input type="hidden" name="seleccionados[]" id="equiposSeleccionados">

                            <!-- Ubicaci√≥n -->
                            <div class="col-md-4">
                            <label for="selectUbicacion" class="form-label">Ubicaci√≥n</label>
                            <input type="text" id="selectUbicacion" name="ubicacionId" class="form-control" required>
                            </div>

                            <!-- Observaciones -->
                            <div class="col-md-4">
                            <label for="selectObservaciones" class="form-label">Observaciones</label>
                            <input type="text" id="selectObservaciones" name="observacionesId" class="form-control" required>
                            </div>

                            <!-- Periodicidad -->
                            <div class="col-md-3">
                            <label for="nuevaPeriodicidad" class="form-label">Periodicidad (meses)</label>
                            <input type="number" id="nuevaPeriodicidad" class="form-control" min="1" required>
                            </div>

                            <!-- Fecha -->
                            <div class="col-md-4">
                            <label for="nuevaFecha" class="form-label">Fecha de ejecuci√≥n</label>
                            <input type="date" id="nuevaFecha" class="form-control" required>
                            </div>
                            
                            <!-- Correo -->
                            <div class="col-md-4">
                            <label for="inputCorreo" class="form-label">Correo de quien recibe:</label>
                            <input type="email" class="form-control" id="inputCorreo" name="correoDestino" required>
                            </div>
                            <!-- Contenedor de espacio derecho del modal -->
                            <div class="col-md-3">
                        
                            </div>
                        </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" id="guardarSeleccionados" class="btn btn-tabla btn-lg"> Guardar seleccionados</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                    
                    </div>
                </div>
            </div>

            <!-- Tabla de visualizaci√≥n de productos -->
            <div class="col-md-14">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered bg-white table-sm" id="tabla">
                            <thead>
                                <tr>
                                    <th>Placa Equipo</th>
                                    <th>Nombre de Equipo</th>
                                    <th>Fecha Compra</th>
                                    <!-- <th>Periodicidad Preventivo (Meses)</th> -->
                                    <th>Mantenimiento Preventivo</th> <!-- Evaluar la palabra actual por vigente -->

                                    <!-- <th>Periodicidad Correctivo (Meses)</th> -->
                                    <th>Mantenimiento Correctivo</th>
                                    <!-- <th>Semaforo Correctivo</th> -->

                                    <th>Tipo Equipo</th>
                                    <th>Estado Equipo</th>
                                    <th>Proceso</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Software</th>
                                    <!-- <th>Disco Duro</th> Criticos -->
                                    <!--<th>Tecnico Responsable</th> Proveedor de Venta -->
                                    <th>Semaforo Peventivo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in tecnologia_equipos %}
                                <tr>
                                    <td>{{ producto.cod_articulo }}</td>
                                    <td>{{ producto.nombre_equipo }}</td>
                                    <td>{{ producto.fecha_ingreso }}</td>

                                    <td>
                                        <span>{{ producto.fecha_mantenimiento }}</span>
                                        <br>
                                        <br>
                                        <span>{{ producto.vencimiento_mantenimiento }}</span>
                                        <input type="hidden"
                                            name="seleccionMantenimiento"
                                            class="form-control fecha-vencimiento"
                                            value="{{ producto.vencimiento_mantenimiento or '' }}"
                                            data-producto-id="{{ producto.cod_articulo }}">

                                        <input 
                                            type="checkbox" 
                                            class="form-check-input"
                                            CheckboxMantenimiento="fecha_mantenimiento" 
                                            data-producto-id="{{ producto.cod_articulo }}"
                                            data-nombre-equipo="{{ producto.nombre_equipo or '' }}"
                                            data-proceso-original="{{ producto.id_proceso or '' }}"
                                            data-estado-inicial="{{ producto.checkbox_mantenimiento }}" 
                                            data-periodicidad-mantenimiento="{{ producto.periodicidad or '' }}" 
                                            data-fecha-mantenimiento="{{ producto.fecha_mantenimiento or '' }}" 
                                            data-vencimiento-mantenimiento="{{ producto.vencimiento_mantenimiento or '' }}" 
                                        
                                            {% if producto.checkbox_mantenimiento == 'Activo' %}checked{% endif %}
                                        >
                                    </td>
                                    <td>
                                        <span>{{ producto.fecha_calibracion }}</span>
                                        <!-- <span>{{ producto.vencimiento_calibracion }}</span> -->
                                        <input type="hidden"
                                            name="seleccionCalibracion"
                                            class="form-control fecha-vencimiento-calibracion"
                                            value="{{ producto.vencimiento_calibracion or '' }}"
                                            data-producto-id="{{ producto.cod_articulo }}">

                                        <input 
                                            type="checkbox" 
                                            class="form-check-input"
                                            CheckboxMantenimiento="fecha_calibracion"
                                            data-producto-id="{{ producto.cod_articulo }}" 
                                            data-nombre-equipo="{{ producto.nombre_equipo }}"
                                            data-proceso-original="{{ producto.id_proceso }}"
                                            data-estado-inicial="{{ producto.checkbox_calibracion }}"
                                            data-periodicidad-calibracion="{{ producto.periodicidad_calibracion or '' }}" 
                                            data-fecha-calibracion="{{ producto.fecha_calibracion or '' }}" 
                                            data-vencimiento-calibracion="{{ producto.vencimiento_calibracion or '' }}" 
                                            
                                            {% if producto.checkbox_calibracion=='Activo' %}checked{% endif %}>
                                    </td>

                                    <td>{{ producto.tipo_equipo }}</td>
                                    <td>
                                        <!-- <form action="{{ url_for('main.update_estado_equipo_tecnologia') }}" method="POST" enctype="multipart/form-data" id="estadoEquipoForm_{{ producto.id }}">
                                            
                                            <select name="nuevo_estado_equipo" id="estadoEquipoSelect_{{ producto.id }}" onchange="estadoEquipoChange(this, {{ producto.id }})">
                                                {% for estadoEquipo in estadoEquipos %}
                                                    <option value="{{ estadoEquipo.estado_equipo }}" {% if producto.estado_equipo == estadoEquipo.estado_equipo %}selected{% endif %}>
                                                        {{ estadoEquipo.estado_equipo }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <br>
                                            <br>
                                        </form> -->
                                        <form action="{{ url_for('main.update_estado_equipo_tecnologia') }}"
                                            method="POST"
                                            id="estadoEquipoForm_{{ producto.cod_articulo }}">

                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="cod_articulo" value="{{ producto.cod_articulo }}">
                                            <input type="hidden" name="nombre_equipo" value="{{ producto.nombre_equipo }}">
                                            <input type="hidden" name="fecha_mantenimiento" value="{{ producto.fecha_mantenimiento }}">
                                            <input type="hidden" name="vencimiento_mantenimiento" value="{{ producto.vencimiento_mantenimiento }}">
                                            <input type="hidden" name="fecha_calibracion" value="{{ producto.fecha_calibracion }}">
                                            <input type="hidden" name="vencimiento_calibracion" value="{{ producto.vencimiento_calibracion }}">
                                            <input type="hidden" name="fecha_ingreso" value="{{ producto.fecha_ingreso }}">
                                            <input type="hidden" name="periodicidad" value="{{ producto.periodicidad }}">
                                            <input type="hidden" name="tipo_equipo" value="{{ producto.tipo_equipo }}">
                                            <input type="hidden" name="estado_equipo" value="{{ producto.estado_equipo }}">
                                            <input type="hidden" name="id_proceso" value="{{ producto.id_proceso }}">
                                            <input type="hidden" name="ram" value="{{ producto.ram }}">
                                            <input type="hidden" name="disco" value="{{ producto.disco }}">
                                            <input type="hidden" name="proveedor_responsable" value="{{ producto.proveedor_responsable }}">
                                            <input type="hidden" name="filepath_to_db_img" value="{{ producto.filepath_to_db_img }}">
                                            <input type="hidden" name="software_instalado" value="{{ producto.software_instalado }}">
                                            <input type="hidden" name="cuidados_basicos" value="{{ producto.cuidados_basicos }}">
                                            <input type="hidden" name="periodicidad_calibracion" value="{{ producto.periodicidad_calibracion }}">
                                            <input type="hidden" name="marca_equipo_tecnologia" value="{{ producto.marca_equipo_tecnologia }}">
                                            <input type="hidden" name="modelo_equipo_tecnologia" value="{{ producto.modelo_equipo_tecnologia }}">
                                            <input type="hidden" name="serial_equipo_tecnologia" value="{{ producto.serial_equipo_tecnologia }}">
                                            <input type="hidden" name="id_persona_responsable" value="{{ producto.id_persona_responsable }}">

                                            <select name="nuevo_estado_equipo"
                                                    data-estado-original="{{ producto.estado_equipo }}"
                                                    onchange="estadoEquipoChange(this, {{ producto.cod_articulo }})">

                                                {% for estadoEquipo in estadoEquipos %}
                                                    <option value="{{ estadoEquipo.estado_equipo }}"
                                                        {% if producto.estado_equipo == estadoEquipo.estado_equipo %}selected{% endif %}>
                                                        {{ estadoEquipo.estado_equipo }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </form>

                                        <form action="{{ url_for('main.update_estado_equipo_tecnologia') }}"
                                            method="POST"
                                            enctype="multipart/form-data"
                                            id="estadoEquipoFormBaja_{{ producto.cod_articulo }}">

                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="cod_articulo" value="{{ producto.cod_articulo }}">
                                            <input type="hidden" name="nombre_equipo" value="{{ producto.nombre_equipo }}">
                                            <input type="hidden" name="fecha_mantenimiento" value="{{ producto.fecha_mantenimiento }}">
                                            <input type="hidden" name="vencimiento_mantenimiento" value="{{ producto.vencimiento_mantenimiento }}">
                                            <input type="hidden" name="fecha_calibracion" value="{{ producto.fecha_calibracion }}">
                                            <input type="hidden" name="vencimiento_calibracion" value="{{ producto.vencimiento_calibracion }}">
                                            <input type="hidden" name="fecha_ingreso" value="{{ producto.fecha_ingreso }}">
                                            <input type="hidden" name="periodicidad" value="{{ producto.periodicidad }}">
                                            <input type="hidden" name="tipo_equipo" value="{{ producto.tipo_equipo }}">
                                            <input type="hidden" name="estado_equipo" value="{{ producto.estado_equipo }}">
                                            <input type="hidden" name="id_proceso" value="{{ producto.id_proceso }}">
                                            <input type="hidden" name="ram" value="{{ producto.ram }}">
                                            <input type="hidden" name="disco" value="{{ producto.disco }}">
                                            <input type="hidden" name="proveedor_responsable" value="{{ producto.proveedor_responsable }}">
                                            <input type="hidden" name="filepath_to_db_img" value="{{ producto.filepath_to_db_img }}">
                                            <input type="hidden" name="software_instalado" value="{{ producto.software_instalado }}">
                                            <input type="hidden" name="cuidados_basicos" value="{{ producto.cuidados_basicos }}">
                                            <input type="hidden" name="periodicidad_calibracion" value="{{ producto.periodicidad_calibracion }}">
                                            <input type="hidden" name="marca_equipo_tecnologia" value="{{ producto.marca_equipo_tecnologia }}">
                                            <input type="hidden" name="modelo_equipo_tecnologia" value="{{ producto.modelo_equipo_tecnologia }}">
                                            <input type="hidden" name="serial_equipo_tecnologia" value="{{ producto.serial_equipo_tecnologia }}">
                                            <input type="hidden" name="id_persona_responsable" value="{{ producto.id_persona_responsable }}">
                                            <input type="hidden" name="nuevo_estado_equipo" value="DE BAJA">
                                            <!-- INPUT REAL QUE FLASK LEE -->
                                            <input type="file" name="pdf_debaja" id="pdf_debaja_{{ producto.cod_articulo }}" hidden>
                                        </form>

                                    </td>
                                    <td>{{ procesoEquiposModal.get(producto.id_proceso, "Sin Proceso") }}</td>
                                    <td> 
                                        {% if producto.ubicacion %}
                                           {{ producto.ubicacion }}
                                        {% else %}
                                            <span class="text-muted"> Sin Ubicaci√≥n </span>
                                        {% endif %}
                                    </td>
                                    <td class="software-cell"
                                        title="{{ producto.software_instalado }}"
                                        data-full="{{ producto.software_instalado|e }}"
                                        data-short="{{ producto.software_instalado[:50]|e }}{% if producto.software_instalado|length > 50 %}...{% endif %}"> <!-- Esta linea muestra el texto en la columna-->

                                        <!-- TEXTO COMPLETO PARA FILTRO -->
                                        <span class="software-full">
                                            {{ producto.software_instalado }}
                                        </span>

                                        <!-- TEXTO CORTO VISIBLE -->
                                        <span class="software-short">
                                            {{ producto.software_instalado[:50] }}
                                            {% if producto.software_instalado|length > 50 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td class="semaforo" data-vencimiento="{{ producto.vencimiento_mantenimiento }}"></td>

                                    <td>
                                        <div class="btn-eliminar">
                                            <a href="{{ url_for('main.GET_EQUIPO_TECNOLOGIA', id=producto['id'], vista='indexTecnologia') }}" class="btn btn-secondary btn-sm"><FONT SIZE=2>Editar/Ver hoja de vida</FONT></a>
                                        </div>
                                        
                                        <br>
                                        <form action="{{ url_for('main.subir_imagen', id_producto=producto.id) }}" 
                                            method="POST" enctype="multipart/form-data" style="display:inline;">
                                            <input type="hidden" name="csrf_token" value="{{csrf_token()}}">
                                            <!-- Input oculto -->
                                            <input type="file" name="imagen_producto" 
                                                id="file-input-{{ producto.id }}" 
                                                style="display:none;" 
                                                onchange="this.form.submit()">

                                            <!-- Bot√≥n que abre el explorador de archivos -->
                                            <div class="btn-eliminar">
                                                <button type="button" class="btn btn-tabla btn-sm"
                                                        onclick="document.getElementById('file-input-{{ producto.id }}').click();">
                                                    Subir_imagen
                                                </button>
                                            </div> 
                                        </form>

                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Modal Acta de Baja -->
            <div class="modal fade" id="modalPdfEquipo" tabindex="9"
                aria-labelledby="modalPdfEquipoLabel"
                aria-hidden="true">

            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal-borde">

                <div class="modal-title text-center w-100 mx-auto">
                    <h5 class="modal-title" id="modalPdfEquipoLabel">
                    Acta de Baja del Equipo
                    </h5>
                </div>

                <div class="modal-body">

                    <div class="alert btn-tabla small mb-3">
                    Este documento es obligatorio para dar de baja el equipo.<br>
                    <strong>Formato permitido:</strong> PDF.
                    </div>

                    <label class="form-label fw-semibold">
                    Seleccionar archivo:
                    </label>

                    <!-- SOLO selector visual -->
                    <input type="file"
                        id="pdf_baja_modal"
                        class="btn-secondary"
                        accept="application/pdf">

                    <div class="form-text">
                    Tama√±o recomendado m√°ximo: 10MB.
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary btn-sm"
                            data-bs-dismiss="modal">
                    Cancelar
                    </button>

                    <button type="button"
                            id="btnConfirmarBaja"
                            class="btn btn-tabla btn-sm">
                    Confirmar Baja
                    </button>
                </div>

                </div>
            </div>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<!-- script para actualizar semaforo de la tabla indexTecnologia.html -->
<script>
function pintarSemaforos() {
    document.querySelectorAll('.semaforo').forEach(el => {
        const fechaStr = el.getAttribute('data-vencimiento');
        if (!fechaStr) {
            el.style.backgroundColor = "gray";
            el.style.width = "25px";
            el.style.height = "25px";
            el.style.borderRadius = "50%";
            el.style.display = "inline-block";
            el.style.border = "1px solid #333";
            el.title = "Sin fecha de vencimiento";
            return;
        }

        const fechaVencimiento = new Date(fechaStr);
        if (isNaN(fechaVencimiento)) {
            el.style.backgroundColor = "gray";
            el.style.width = "25px";
            el.style.height = "25px";
            el.style.borderRadius = "50%";
            el.style.display = "inline-block";
            el.style.border = "1px solid #333";
            el.title = "Sin fecha";
            return;
        }

        const hoy = new Date();
        const diffDias = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));

        let color = "green";
        if (diffDias < 0) {
            color = 'red';
        } else if (diffDias <= 30) {
            color = 'yellow';
        }

        el.style.backgroundColor = color;
        el.style.width = "25px";
        el.style.height = "25px";
        el.style.borderRadius = "50%";
        el.style.display = "inline-block";
        el.style.border = "1px solid #333";
        el.title = `Vence en ${diffDias} d√≠as`;
    });
}
// <!-- boton de busqueda y filtro, con lenguaje en espa√±ol -->
document.addEventListener("DOMContentLoaded", function () {
    // Inicializar DataTable
    const tabla = $("#tabla").DataTable({
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
        }
    });

    // Pintar sem√°foros al cargar
    pintarSemaforos();

    // Repintar cada vez que la tabla se redibuja (cambio de p√°gina)
    tabla.on('draw.dt', function () {
        const searchTerm = tabla.search().trim().toLowerCase();

        document.querySelectorAll('.software-cell').forEach(td => {

            const full = td.dataset.full || "";
            const shortText = td.dataset.short || "";

            if (!searchTerm) {
                // üîÅ sin b√∫squeda ‚Üí vuelve resumido
                td.textContent = shortText;
                return;
            }

            const lowerFull = full.toLowerCase();
            const index = lowerFull.indexOf(searchTerm);

            if (index === -1) {
                // no match visible ‚Üí deja corto
                td.textContent = shortText;
                return;
            }

            // üß† sacar fragmento alrededor
            const CONTEXT = 25;

            const start = Math.max(0, index - CONTEXT);
            const end = Math.min(full.length, index + searchTerm.length + CONTEXT);

            let fragment = full.substring(start, end);

            if (start > 0) fragment = "..." + fragment;
            if (end < full.length) fragment += "...";

            // üé® highlight
            const regex = new RegExp(`(${searchTerm})`, "gi");
            fragment = fragment.replace(regex, '<mark>$1</mark>');

            td.innerHTML = fragment;
        });
        pintarSemaforos();
    });
});
</script>

<!-- script para mostrar alerta al cambiar de estado de equipo -->
<script>
let currentEquipoId = null;

function estadoEquipoChange(select, codArticulo) {

    if (!confirm("¬øEst√° seguro de cambiar el estado del equipo?")) {
        select.value = select.getAttribute("data-estado-original");
        return;
    }

    if (select.value === "DE BAJA") {
        currentEquipoId = codArticulo;
        new bootstrap.Modal(
            document.getElementById("modalPdfEquipo")
        ).show();
    } else {
        document.getElementById(
            "estadoEquipoForm_" + codArticulo
        ).submit();
    }
}

document.getElementById("btnConfirmarBaja").addEventListener("click", () => {

    const modalInput = document.getElementById("pdf_baja_modal");
    const pdfFile = modalInput.files[0];

    if (!pdfFile) {
        alert("Debe adjuntar el acta de baja en PDF.");
        return;
    }

    const hiddenInput = document.getElementById(
        "pdf_debaja_" + currentEquipoId
    );

    const dt = new DataTransfer();
    dt.items.add(pdfFile);
    hiddenInput.files = dt.files;

    modalInput.value = ""; // limpia selector

    document.getElementById(
        "estadoEquipoFormBaja_" + currentEquipoId
    ).submit();
});

</script>

<!-- script para mostrar alerta al cambiar de estado de equipo DE BAJA desde el formulario manual-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const estadoSelect = document.getElementById("estado_equipo");
  const pdfInput = document.getElementById("pdf_debaja");
  const pdfBtn = document.getElementById("btnPdfBaja");
  const pdfName = document.getElementById("nombre-pdf");

  function togglePdfBaja() {
    const esBaja = estadoSelect.value === "DE BAJA";

    pdfInput.disabled = !esBaja;
    pdfInput.required = esBaja;

    if (esBaja) {
      pdfBtn.classList.remove("disabled");
      pdfBtn.setAttribute("aria-disabled", "false");
      pdfBtn.classList.remove("btn-secondary");
      pdfBtn.classList.add("btn-danger");
    } else {
      // limpiar selecci√≥n si cambia a otro estado
      pdfInput.value = "";
      pdfName.textContent = "";

      pdfBtn.classList.add("disabled");
      pdfBtn.setAttribute("aria-disabled", "true");
      pdfBtn.classList.remove("btn-danger");
      pdfBtn.classList.add("btn-secondary");
    }
  }

  estadoSelect.addEventListener("change", togglePdfBaja);

  pdfInput.addEventListener("change", () => {
    const file = pdfInput.files && pdfInput.files[0];
    if (!file) {
      pdfName.textContent = "";
      return;
    }
    if (!file.name.toLowerCase().endsWith(".pdf")) {
      alert("Solo se permiten archivos PDF.");
      pdfInput.value = "";
      pdfName.textContent = "";
      return;
    }
    pdfName.textContent = file.name;
  });

  // estado inicial
  togglePdfBaja();
});
</script>

<!-- Scripts para el ocultar el formulario -->
<script>
    document.getElementById('toggleFormBtn').addEventListener('click', function () {
        var formContainer = document.getElementById('formContainer');
        var toggleBtn = document.getElementById('toggleFormBtn');

        if (formContainer.style.display === 'none' || formContainer.style.display === '') {
            formContainer.style.display = 'block';
            toggleBtn.textContent = ' Ocultar Formulario';
        } else {
            formContainer.style.display = 'none';
            toggleBtn.textContent = ' Agregar Equipo Manual';
        }
    });
</script>

<!-- Scripts para insertar equipos masivos .CSV -->
<script>
    document.getElementById('toggleForm').addEventListener('click', function () {
        var formContain = document.getElementById('formContain');
        var toggleBtn = document.getElementById('toggleForm');

        if (formContain.style.display === 'none' || formContain.style.display === '') {
            formContain.style.display = 'block';
            toggleBtn.textContent = ' Ocultar .xlsx';
        } else {
            formContain.style.display = 'none';
            toggleBtn.textContent = ' Cargar Equipos Masivos .xlsx';
        }
    });
</script>

<!-- Scripts para actualizar fechas masivamente  -->
<script>
document.getElementById("guardarSeleccionados").addEventListener("click", async function () {

    const btn = this;
    
    // Desactivar bot√≥n y mostrar spinner
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm"></span>
        Procesando...
    `;

    // Armar registros seleccionados
    const registros = window.equiposSeleccionadosGlobal || [];

    const data = {
        proveedorId: document.getElementById("selectProveedor").value,
        personaId: document.getElementById("selectPersona").value,
        procesoId: document.getElementById("selectProceso").value,
        ubicacionId: document.getElementById("selectUbicacion").value,
        observacionesId: document.getElementById("selectObservaciones").value,
        nuevaFecha: document.getElementById("nuevaFecha").value,
        nuevaPeriodicidad: document.getElementById("nuevaPeriodicidad").value,
        correoExterno: document.getElementById("inputCorreo").value,
        registros: registros
    };

    try {
        let response = await fetch("/mantenimientos-tecnologia/guardar_historialTecnologia", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}"
            },
            body: JSON.stringify(data)
        });

        let result = await response.json();

        if (result.success) {
            Swal.fire({
                icon: "success",
                title: "Guardado exitoso",
                text: result.message,
            });

            // Cerrar modal
            let modal = bootstrap.Modal.getInstance(document.getElementById("modalGuardar"));
            modal.hide();

            // Recargar tabla o p√°gina
            setTimeout(() => location.reload(), 800);

        } else {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: result.message,
            });

            // Rehabilitar bot√≥n
            btn.disabled = false;
            btn.textContent = "Guardar seleccionados";
        }

    } catch (error) {
        Swal.fire({
            icon: "error",
            title: "Error inesperado",
            text: error.toString(),
        });

        btn.disabled = false;
        btn.textContent = "Guardar seleccionados";
    }
});
</script>

<!-- Scripts para el checkbox (Para activar o desactivar manualmente desde la tabla.) -->
<script>
    var csrf_token = "{{ csrf_token() }}";
</script>

{% endblock %}
